name: Audit Environment Configuration

on:
  workflow_dispatch:
    inputs:
      # 1. NATIVE DROPDOWN: Generates a list of environments from your repo settings
      environment:
        description: "Target Environment to Audit"
        required: true
        type: environment

jobs:
  audit-config:
    runs-on: ubuntu-latest
    # 2. DYNAMIC BINDING: Binds the job to the selected environment
    environment: ${{ inputs.environment }}

    env:
      # Dump contexts to JSON strings for parsing
      # 'vars' = Plaintext variables (Safe to view values)
      # 'secrets' = Encrypted secrets (Values masked as ***)
      VARS_JSON: ${{ toJSON(vars) }}
      SECRETS_JSON: ${{ toJSON(secrets) }}

    steps:
      - name: Audit - Effective Environment Variables (Non-Secrets)
        shell: bash
        run: |
          echo "=== Effective Variables for '${{ inputs.environment }}' ==="
          echo "(Includes merged Repository and Environment variables)"
          echo ""
          
          # Use jq to parse the JSON and print Key=Value pairs
          echo "$VARS_JSON" | jq -r 'to_entries[] | "\(.key) = \(.value)"' | sort

      - name: Audit - Effective Secret Keys (Names Only)
        shell: bash
        run: |
          echo ""
          echo "=== Effective Secret Keys for '${{ inputs.environment }}' ==="
          echo "(Values are strictly masked by GitHub, printing names only)"
          echo ""
          
          # Use jq to extract only the keys (names) from the secrets object
          echo "$SECRETS_JSON" | jq -r 'keys[]' | sort | while read -r key; do
            echo "[SECRET] $key"
          done
