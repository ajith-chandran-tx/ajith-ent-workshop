name: Audit Dev Environment Secrets

on:
  workflow_dispatch:

jobs:
  audit-dev-secrets:
    runs-on: ubuntu-latest
    # CRITICAL: This attaches the job to the 'dev' environment.
    # The 'secrets' context will now automatically include/override
    # keys defined in the 'dev' environment settings.
    environment: dev

    # Dump the merged secret context (Repo + Dev Overrides)
    env:
      RUNTIME_SECRETS_JSON: ${{ toJSON(secrets) }}

    steps:
      - name: Debug - Print Effective Secret Keys for 'dev'
        shell: bash
        run: |
          echo "=== Effective Secrets for Environment: dev ==="
          echo "Note: This list includes both Repository secrets AND Environment secrets."
          echo "(If a key exists in both, the Environment value takes precedence)."
          echo ""
          
          # Use jq to extract keys from the JSON dump
          # We mask values but print the keys.
          echo "$RUNTIME_SECRETS_JSON" | jq -r 'keys[]' | sort | while read -r key; do
            echo "Secret Key: $key"
          done

      # OPTIONAL: If you strictly need the list from the Settings UI
      # You MUST provide a PAT (Personal Access Token) with 'repo' scope.
      # The default GITHUB_TOKEN cannot perform 'gh secret list'.
      # - name: Strict Environment Definition (Requires PAT)
      #   env:
      #     GH_TOKEN: ${{ secrets.MY_ADMIN_PAT }}
      #   run: |
      #     echo "=== Explicit 'dev' Environment Definitions ==="
      #     gh secret list --env dev
