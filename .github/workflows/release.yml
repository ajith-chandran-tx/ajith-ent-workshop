name: Validate Schemas And Create Release Branch

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment (dev/test/preprod/prod)"
        required: true
        default: "dev"
permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover Dynamic Schemas from Environment
        id: discover_dynamic
        shell: bash
        run: |
          set -euo pipefail

          echo "Scanning environment for S{n}_ groups..."
          GROUPS=$(env | grep -Eo '^S[0-9]+_NAME=' | sed 's/_NAME=.*//' | sort -u || true)

          mkdir -p .tmp-introspected
          : > dynamic_schemas.list

          for G in $GROUPS; do
            NAME_VAR="${G}_NAME"
            URL_VAR="${G}_URL"
            NAME="${!NAME_VAR-}"
            URL="${!URL_VAR-}"

            if [ -z "${NAME:-}" ] || [ -z "${URL:-}" ]; then
              echo "Skipping $G because NAME or URL is missing."
              continue
            fi

            HEADER_VARS=$(env | grep -E "^${G}_HEADER_" | cut -d= -f1 || true)
            HEADERS_JOINED=""
            if [ -n "${HEADER_VARS:-}" ]; then
              HEADERS_JOINED=$(echo "$HEADER_VARS" | paste -sd, -)
            fi

            echo "${NAME}|${URL}|${HEADERS_JOINED}" >> dynamic_schemas.list
          done

          if [ -s dynamic_schemas.list ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Dynamic schemas discovered:"
            cat dynamic_schemas.list
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No dynamic schemas discovered."
          fi
