name: Isolate and Copy Files
on:
  workflow_dispatch: # Allows manual trigger

# 1. Essential: Grant permission to write to the repository
permissions:
  contents: write

jobs:
  audit-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v4

      - name: Prepare Isolated Audit Branch
        env:
          AUDIT_BRANCH: "audit-logs"
          TARGET_FOLDER: "audit-isolated"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Define the authenticated URL
          REPO_URL="https://x-access-token:${GH_TOKEN}@://github.com{{ github.repository }}.git"
          
          # Setup Git Identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Check if the branch exists on remote
          if git ls-remote --exit-code --heads origin "$AUDIT_BRANCH"; then
            echo "Branch exists. Cloning into $TARGET_FOLDER..."
            git clone --branch "$AUDIT_BRANCH" --single-branch "$REPO_URL" "$TARGET_FOLDER"
          else
            echo "Branch does not exist. Creating empty orphan branch..."
            mkdir -p "$TARGET_FOLDER"
            cd "$TARGET_FOLDER"
            git init
            git checkout --orphan "$AUDIT_BRANCH"
            git commit --allow-empty -m "Initial empty commit for audit branch"
            git remote add origin "$REPO_URL"
            # Push the new branch so it exists for future steps
            git push -u origin "$AUDIT_BRANCH"
            cd ..
          fi

      - name: Copy Files and Push
        env:
          TARGET_FOLDER: "audit-isolated"
          AUDIT_BRANCH: "audit-logs"
        run: |
          # Example: Copying specific files from the current branch/run to the isolated folder
          # Replace 'audit-file.log' with your actual file names
          cp ./important-results.txt ./"$TARGET_FOLDER"/ 2>/dev/null || echo "File not found"
          
          cd "$TARGET_FOLDER"
          
          # Only commit and push if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Update audit logs from GitHub Action"
            git push origin "$AUDIT_BRANCH"
          else
            echo "No changes to commit."
          fi
